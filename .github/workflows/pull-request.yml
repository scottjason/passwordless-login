name: CI/CD Pipeline for Backend and Frontend on Pull Request

on:
  pull_request:
    branches:
      - "*"
permissions:
  pull-requests: write
  contents: read

jobs:
  build-backend-and-run-tests:
    runs-on: ubuntu-latest
    env:
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_USERNAME: ${{ secrets.REDIS_USERNAME }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      REDIS_USE_SSL: ${{ secrets.REDIS_USE_SSL }}
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Debug Environment Variables
        run: |
          echo "üîç Debugging Environment Variables:"
          echo "REDIS_HOST=${REDIS_HOST}"
          echo "REDIS_PORT=${REDIS_PORT}"
          echo "REDIS_USERNAME=${REDIS_USERNAME}"
          echo "REDIS_PASSWORD=********"  # Hide password for security
          echo "REDIS_USE_SSL=${REDIS_USE_SSL}"

      - name: Checkout backend code
        uses: actions/checkout@v2

      - name: Set up Python environment
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd backend
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt

      - name: Run backend tests with pytest
        run: |
          cd backend
          source venv/bin/activate
          pytest -v

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      - name: Comment on PR if tests pass
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ Backend tests passed successfully! üéâ"

  build-frontend-and-run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend code
        uses: actions/checkout@v2

      - name: Set up Docker for frontend
        run: |
          docker build -f frontend/Dockerfile -t passwordless-frontend .

      - name: Run frontend tests
        run: |
          docker run passwordless-frontend npm test

      - name: Install GitHub CLI
        run: sudo apt-get install gh

      - name: Comment on PR if tests pass
        if: success()
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ Frontend tests passed successfully! üéâ"
